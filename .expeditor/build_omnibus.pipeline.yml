env:
  BUILD_TIMESTAMP: 2019-11-06_17_00

steps:
  - label: ":hammer_and_wrench: ubuntu-16.04-x86_64"
    agents:
      queue: gemtest-ubuntu-16.04-x86_64
    plugins:
      chef/omnibus#master:
        build: harmony
        omnibus-pipeline-definition-path: .expeditor/build.omnibus.yml
        adhoc: true

  - label: ":hammer_and_wrench: windows-2019-x86_64"
    agents:
      queue: gemtest-windows-2019-x86_64
    plugins:
      chef/omnibus#master:
        build: harmony
        omnibus-pipeline-definition-path: .expeditor/build.omnibus.yml
        adhoc: true

  - wait

  - label: Create Build Record
    plugins:
      chef/omnibus#master:
        create-build-record: harmony

  # - label: set metadata
  #   command: buildkite-agent meta-data set "harmony_build_version" "0.1.0+20190315112233.git.54.18d8f48"

  - wait

  - label: ":mag: ubuntu-16.04-x86_64"
    agents:
      queue: gemtest-ubuntu-16.04-x86_64
    plugins:
      chef/omnibus#master:
        test: harmony
        test-path: omnibus-test.sh

  - label: ":mag: windows-2019-x86_64"
    agents:
      queue: gemtest-windows-2019-x86_64
    plugins:
      chef/omnibus#master:
        test: harmony
        test-path-windows: omnibus-test.ps1

  # # - wait

  # # - label: Promote to Current
  # #   plugins:
  # #     chef/omnibus#master:
  # #       promote: harmony
